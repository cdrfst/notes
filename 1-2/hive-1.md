# Hive

## 1.找出全部夺得3连贯的队伍

### 思路：属于连续值的求解：

- 1.使用 row_number 在组内给数据编号(rownum) 
- 2.year - rownum = gid，得到gid作为后面分组计算的依据 
- 3.根据求得的gid，作为分组条件，求最终结果

![image-20210520113750054](images\image-20210520113750054.png)



## 2.找出每个id在在一天之内所有的波峰与波谷值

### 思路：

- 1.将当前值 price  前一个值 lag  后一个值 lead 放在同一行
- 2.如果当前值比前后两个值大即波峰 ,当前值比前后两个值小即波谷 

![image-20210520113930563](images\image-20210520113930563.png)

## 3.写SQL

### 3.1.每个id浏览时长、步长

#### 思路：此题测试数据为一天的数据,所以根据要求将同一用户最后一次访问时间 和 首次访问时间放在一行 然后相减：

- 1.创建基础数据 按用户id分区后再按时间倒序,因unix_timestamp对 2020/09/12 不支持且输入参数必须到秒,所以在基础数据中直接将"/“替换成"-" 并在后面拼了':00'
- 2.按用户分区按dt升序算出每行的最大及最小值、用户步长 count 
- 3.取用户最后一次访问时间所在行的最大和最小值 进行减运算
- 4.将单位转为分钟显示

![image-20210520114346367](images\image-20210520114346367.png)

### 3.2.如果两次浏览之间的间隔超过30分钟，认为是两个不同的浏览时间；再求每个id浏

#### 思路：

- 1.行函数计算出相邻两条记录的时间差(分钟)
- 2.标记两次浏览之间时间间隔超过30分钟的记录 如用flag列 1为超过30分钟的记录 0为不足30分钟的记录
- 3.按用户id 和 flag 分组 计算 sum(diff) 时长,count(id) 步长

![image-20210520114538328](images\image-20210520114538328.png)